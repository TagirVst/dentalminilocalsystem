# Установка и запуск резервной системы учёта пациентов стоматологии

## Системные требования

- **ОС**: Ubuntu 22.04 LTS (рекомендуется)
- **Node.js**: версия 18 или выше
- **PostgreSQL**: версия 14 или выше
- **RAM**: минимум 2 ГБ
- **Дисковое пространство**: минимум 5 ГБ

## Установка зависимостей на Ubuntu 22.04

### 1. Обновление системы
```bash
sudo apt update && sudo apt upgrade -y
```

### 2. Установка Node.js 18
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### 3. Установка PostgreSQL
```bash
sudo apt install postgresql postgresql-contrib -y
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### 4. Настройка PostgreSQL
```bash
# Создание пользователя и базы данных
sudo -u postgres psql

-- В консоли PostgreSQL:
CREATE DATABASE dental_backup;
CREATE USER dental_user WITH PASSWORD 'your_password_here';
GRANT ALL PRIVILEGES ON DATABASE dental_backup TO dental_user;
\q
```

## Установка и настройка системы

### 1. Переход в директорию проекта
```bash
cd dental-system
```

### 2. Установка зависимостей
```bash
npm run install:all
```

### 3. Настройка переменных окружения
```bash
cd server
cp .env.example .env
nano .env
```

Заполните файл `.env`:
```env
NODE_ENV=production
PORT=5000
HOST=192.168.2.67

# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=dental_backup
DB_USER=dental_user
DB_PASSWORD=your_password_here

# Session
SESSION_SECRET=your-very-secure-secret-key-here
```

### 4. Запуск миграций и заполнение начальными данными
```bash
cd server
npm run migrate
npm run seed
```

### 5. Сборка frontend приложения
```bash
cd ../client
npm run build
```

## Запуск системы

### Разработка (с горячей перезагрузкой)
```bash
# Из корневой директории проекта
npm run dev
```

### Продакшн
```bash
# Из корневой директории проекта
npm start
```

Система будет доступна по адресу: **http://192.168.2.67:3000**

## Тестовые аккаунты

После выполнения seeders будут созданы следующие пользователи:

| Роль | Логин | Пароль | Описание |
|------|-------|--------|----------|
| Врач | `doctor1` | `123456` | Доктор Иванов |
| Врач | `doctor2` | `123456` | Доктор Петрова |
| Администратор | `admin` | `123456` | Администратор Сидорова |
| Управляющий | `manager` | `123456` | Управляющий Коваленко |

## Функции по ролям

### Врач
- ✅ Просмотр своих визитов за сегодня
- ✅ Создание новых визитов
- ❌ Редактирование сохранённых визитов
- ❌ Просмотр визитов других врачей

### Администратор
- ✅ Просмотр всех визитов за сегодня и вчера
- ✅ Группировка визитов по врачам
- ✅ Регистрация оплаты визитов
- ❌ Изменение оплаты после сохранения
- ❌ Управление услугами

### Управляющий
- ✅ Просмотр всех визитов за любой день
- ✅ Добавление новых услуг
- ✅ Изменение цен услуг (без ретроактивного изменения)
- ✅ Календарь для выбора даты
- ❌ Изменение визитов и оплат

## Настройка автозапуска (systemd)

Создайте файл сервиса:
```bash
sudo nano /etc/systemd/system/dental-backup.service
```

Содержимое файла:
```ini
[Unit]
Description=Dental Backup System
After=network.target postgresql.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/path/to/dental-system
Environment=NODE_ENV=production
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Активация сервиса:
```bash
sudo systemctl daemon-reload
sudo systemctl enable dental-backup
sudo systemctl start dental-backup
```

## Резервное копирование

### Создание резервной копии БД
```bash
pg_dump -h localhost -U dental_user dental_backup > backup_$(date +%Y%m%d_%H%M%S).sql
```

### Восстановление из резервной копии
```bash
psql -h localhost -U dental_user dental_backup < backup_file.sql
```

## Решение проблем

### Проблема с подключением к БД
```bash
# Проверка статуса PostgreSQL
sudo systemctl status postgresql

# Проверка логов
sudo journalctl -u postgresql
```

### Проблема с правами доступа
```bash
# Проверка прав пользователя БД
sudo -u postgres psql -c "\du"
```

### Система не запускается
```bash
# Проверка логов системы
sudo journalctl -u dental-backup -f
```

### Сброс пароля пользователя
```bash
cd server
npx sequelize-cli db:seed:undo --seed 20240101000001-initial-users.js
npx sequelize-cli db:seed --seed 20240101000001-initial-users.js
```

## Обновление системы

1. Остановка системы:
```bash
sudo systemctl stop dental-backup
```

2. Создание резервной копии:
```bash
pg_dump -h localhost -U dental_user dental_backup > backup_before_update.sql
```

3. Обновление кода и зависимостей:
```bash
git pull  # если используется Git
npm run install:all
cd client && npm run build
```

4. Запуск миграций (при наличии):
```bash
cd server && npm run migrate
```

5. Запуск системы:
```bash
sudo systemctl start dental-backup
```

## Мониторинг

### Проверка статуса системы
```bash
sudo systemctl status dental-backup
curl http://192.168.2.67:3000
```

### Просмотр логов в реальном времени
```bash
sudo journalctl -u dental-backup -f
```

### Проверка использования ресурсов
```bash
htop
df -h
free -h
```

## Безопасность

1. **Смените пароли по умолчанию** в продакшн среде
2. **Настройте фаервол** для ограничения доступа
3. **Регулярно создавайте резервные копии**
4. **Обновляйте зависимости** для исправления уязвимостей

```bash
# Настройка базового фаервола
sudo ufw enable
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 3000/tcp  # Приложение (или настроить reverse proxy)
```

## Техническая поддержка

При возникновении проблем проверьте:
1. Логи системы (`journalctl`)
2. Логи PostgreSQL
3. Доступность порта 3000
4. Свободное место на диске
5. Статус сетевого подключения

Система спроектирована для надёжной работы в локальной сети без интернета при наличии резервного питания. 

## Системные требования

- **ОС**: Ubuntu 22.04 LTS (рекомендуется)
- **Node.js**: версия 18 или выше
- **PostgreSQL**: версия 14 или выше
- **RAM**: минимум 2 ГБ
- **Дисковое пространство**: минимум 5 ГБ

## Установка зависимостей на Ubuntu 22.04

### 1. Обновление системы
```bash
sudo apt update && sudo apt upgrade -y
```

### 2. Установка Node.js 18
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### 3. Установка PostgreSQL
```bash
sudo apt install postgresql postgresql-contrib -y
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### 4. Настройка PostgreSQL
```bash
# Создание пользователя и базы данных
sudo -u postgres psql

-- В консоли PostgreSQL:
CREATE DATABASE dental_backup;
CREATE USER dental_user WITH PASSWORD 'your_password_here';
GRANT ALL PRIVILEGES ON DATABASE dental_backup TO dental_user;
\q
```

## Установка и настройка системы

### 1. Переход в директорию проекта
```bash
cd dental-system
```

### 2. Установка зависимостей
```bash
npm run install:all
```

### 3. Настройка переменных окружения
```bash
cd server
cp .env.example .env
nano .env
```

Заполните файл `.env`:
```env
NODE_ENV=production
PORT=5000
HOST=192.168.2.67

# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=dental_backup
DB_USER=dental_user
DB_PASSWORD=your_password_here

# Session
SESSION_SECRET=your-very-secure-secret-key-here
```

### 4. Запуск миграций и заполнение начальными данными
```bash
cd server
npm run migrate
npm run seed
```

### 5. Сборка frontend приложения
```bash
cd ../client
npm run build
```

## Запуск системы

### Разработка (с горячей перезагрузкой)
```bash
# Из корневой директории проекта
npm run dev
```

### Продакшн
```bash
# Из корневой директории проекта
npm start
```

Система будет доступна по адресу: **http://192.168.2.67:3000**

## Тестовые аккаунты

После выполнения seeders будут созданы следующие пользователи:

| Роль | Логин | Пароль | Описание |
|------|-------|--------|----------|
| Врач | `doctor1` | `123456` | Доктор Иванов |
| Врач | `doctor2` | `123456` | Доктор Петрова |
| Администратор | `admin` | `123456` | Администратор Сидорова |
| Управляющий | `manager` | `123456` | Управляющий Коваленко |

## Функции по ролям

### Врач
- ✅ Просмотр своих визитов за сегодня
- ✅ Создание новых визитов
- ❌ Редактирование сохранённых визитов
- ❌ Просмотр визитов других врачей

### Администратор
- ✅ Просмотр всех визитов за сегодня и вчера
- ✅ Группировка визитов по врачам
- ✅ Регистрация оплаты визитов
- ❌ Изменение оплаты после сохранения
- ❌ Управление услугами

### Управляющий
- ✅ Просмотр всех визитов за любой день
- ✅ Добавление новых услуг
- ✅ Изменение цен услуг (без ретроактивного изменения)
- ✅ Календарь для выбора даты
- ❌ Изменение визитов и оплат

## Настройка автозапуска (systemd)

Создайте файл сервиса:
```bash
sudo nano /etc/systemd/system/dental-backup.service
```

Содержимое файла:
```ini
[Unit]
Description=Dental Backup System
After=network.target postgresql.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/path/to/dental-system
Environment=NODE_ENV=production
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Активация сервиса:
```bash
sudo systemctl daemon-reload
sudo systemctl enable dental-backup
sudo systemctl start dental-backup
```

## Резервное копирование

### Создание резервной копии БД
```bash
pg_dump -h localhost -U dental_user dental_backup > backup_$(date +%Y%m%d_%H%M%S).sql
```

### Восстановление из резервной копии
```bash
psql -h localhost -U dental_user dental_backup < backup_file.sql
```

## Решение проблем

### Проблема с подключением к БД
```bash
# Проверка статуса PostgreSQL
sudo systemctl status postgresql

# Проверка логов
sudo journalctl -u postgresql
```

### Проблема с правами доступа
```bash
# Проверка прав пользователя БД
sudo -u postgres psql -c "\du"
```

### Система не запускается
```bash
# Проверка логов системы
sudo journalctl -u dental-backup -f
```

### Сброс пароля пользователя
```bash
cd server
npx sequelize-cli db:seed:undo --seed 20240101000001-initial-users.js
npx sequelize-cli db:seed --seed 20240101000001-initial-users.js
```

## Обновление системы

1. Остановка системы:
```bash
sudo systemctl stop dental-backup
```

2. Создание резервной копии:
```bash
pg_dump -h localhost -U dental_user dental_backup > backup_before_update.sql
```

3. Обновление кода и зависимостей:
```bash
git pull  # если используется Git
npm run install:all
cd client && npm run build
```

4. Запуск миграций (при наличии):
```bash
cd server && npm run migrate
```

5. Запуск системы:
```bash
sudo systemctl start dental-backup
```

## Мониторинг

### Проверка статуса системы
```bash
sudo systemctl status dental-backup
curl http://192.168.2.67:3000
```

### Просмотр логов в реальном времени
```bash
sudo journalctl -u dental-backup -f
```

### Проверка использования ресурсов
```bash
htop
df -h
free -h
```

## Безопасность

1. **Смените пароли по умолчанию** в продакшн среде
2. **Настройте фаервол** для ограничения доступа
3. **Регулярно создавайте резервные копии**
4. **Обновляйте зависимости** для исправления уязвимостей

```bash
# Настройка базового фаервола
sudo ufw enable
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 3000/tcp  # Приложение (или настроить reverse proxy)
```

## Техническая поддержка

При возникновении проблем проверьте:
1. Логи системы (`journalctl`)
2. Логи PostgreSQL
3. Доступность порта 3000
4. Свободное место на диске
5. Статус сетевого подключения

Система спроектирована для надёжной работы в локальной сети без интернета при наличии резервного питания. 